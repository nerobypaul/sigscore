# Changelog — 2026-02-20

## 13:00 — Fix concurrent token refresh race + demo seed cascade delete

**Task:** Fix production demo seed 500 error and token rotation cascade that logged users out on multi-page navigation

**Changes:**
- frontend/src/lib/api.ts — Added shared refresh promise to prevent concurrent 401s from racing on the same refresh token. Multiple simultaneous 401s now queue behind a single refresh call instead of each consuming the token independently.
- frontend/src/pages/Signals.tsx — Fixed `account` query param to `accountId` (matching backend controller expectation)
- backend/prisma/schema.prisma — Added `onDelete: Cascade` to EmailSequence → Organization relation (the only org relation missing it)
- backend/prisma/schema.prisma — Added `onDelete: Cascade` to EmailEnrollment → EmailSequence, EmailEnrollment → Contact, EmailSend → EmailEnrollment, EmailSend → EmailSequenceStep
- backend/prisma/migrations/20260220140000_add_cascade_delete_email_sequences/migration.sql — Migration to alter FK constraints
- backend/tsconfig.json — Added `ts-node: { files: true }` so ts-node honors include globs and picks up `src/types/express.d.ts`

**Production verification:**
- Demo seed: now works (was returning 500 due to FK violation on org delete)
- Health: DB up, Redis up
- Contacts: 18, Signals: 395, PQA: 8 scored accounts, Deals: 3, Workflows: 2
- Migration applied on deploy via `prisma migrate deploy`

**Decisions:**
- Used shared promise pattern for refresh queue (simpler than mutex/semaphore, no added deps)
- Added cascades to entire email sequence chain (Sequence → Steps → Sends, Sequence → Enrollments → Sends) to prevent any future FK issues on org deletion

**Status:** completed

## 21:00 — Enrich demo seed for Show HN + full codebase audit

**Task:** Run comprehensive frontend/backend/demo audits, then enrich demo data for maximum Show HN impact

**Audit Results:**
- Frontend: 58 pages audited, 0 critical bugs, 1 high (console.error in Landing.tsx, fixed)
- Backend: 63 route files audited, 0 critical bugs, all auth properly enforced
- Demo: Data quality excellent, needed more signal volume and AI brief coverage

**Changes:**
- backend/src/services/demo-seed.ts — Increased signal count from 395 to 600 across all 8 companies
- backend/src/services/demo-seed.ts — Added AI briefs for NovaCLI and CloudForge (previously only Acme had one)
- backend/src/services/demo-seed.ts — Added Segment and Discord signal sources (6 total, up from 4)
- backend/src/services/demo-seed.ts — Added 7 new signal templates: segment_identify, segment_track, discord_join, discord_thread, docs_read, github_commit
- frontend/src/pages/Landing.tsx — Removed console.error from demo seed error handler

**Production verification:**
- Demo seed: 8 companies, 18 contacts, 600 signals, 3 deals, 2 workflows
- 3 AI briefs (Acme: expansion, NovaCLI: early adoption, CloudForge: competitive switch)
- PQA: 8 scored accounts with 14-day history
- All endpoints returning correct data

**Decisions:**
- Signal distribution kept proportional: HOT (210/130), WARM (95/65/45), COLD (25/18/12)
- AI briefs varied by narrative: expansion play, founder-friendly pricing, competitive displacement
- Added Segment + Discord sources to better showcase the "16 sources" promise

**Status:** completed

## 22:30 — Production load test, fix search 500 + concurrent demo seed race

**Task:** Run production E2E tests and load test simulating 10 concurrent Show HN visitors; fix all issues found

**Issues Found & Fixed:**

1. **Search 500 error** — `search_vector` column doesn't exist on production (migration marked applied but ALTER TABLE never ran)
   - backend/prisma/migrations/20260220200000_repair_fulltext_search/migration.sql — Repair migration re-adds search_vector columns
   - backend/src/services/search.ts — Added ILIKE fallback for both `globalSearch` and `groupedSearch` so search works even without tsvector columns

2. **Concurrent demo seed race (P2025)** — All 10 concurrent demo seeds tried to delete the same singleton org; first wins, 9 fail
   - backend/src/services/demo-seed.ts — Each demo session now gets a unique slug (`devsignal-demo-{ts}-{random}`) so concurrent visitors don't interfere
   - backend/src/services/demo-seed.ts — `cleanupDemoOrg` now catches P2025 (already deleted) gracefully
   - backend/src/services/demo-seed.ts — `getDemoStatus` uses `findFirst`+`startsWith` instead of `findUnique`
   - backend/src/services/demo-seed.ts — Pre-computed bcrypt hash eliminates ~150ms CPU per request under load

**Load Test Results (10 concurrent visitors):**
- Error rate: 0% (was 90% before fix)
- Landing page: 258ms p50
- Demo seed: 19.8s p50 (600 rows per org, acceptable for one-time setup)
- API browsing: 1.4-2.1s p50 (Railway standard tier latency)
- Verdict: PASS — ready for Show HN traffic

**Decisions:**
- ILIKE fallback is belt-and-suspenders — repair migration should create the columns, but fallback prevents future 500s
- Unique demo slugs trade slight DB bloat for zero-contention concurrency. Cleanup cron already handles stale orgs via `startsWith: 'devsignal-demo'`

**Status:** completed
