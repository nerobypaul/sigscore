# Changelog — 2026-02-20

## 13:00 — Fix concurrent token refresh race + demo seed cascade delete

**Task:** Fix production demo seed 500 error and token rotation cascade that logged users out on multi-page navigation

**Changes:**
- frontend/src/lib/api.ts — Added shared refresh promise to prevent concurrent 401s from racing on the same refresh token. Multiple simultaneous 401s now queue behind a single refresh call instead of each consuming the token independently.
- frontend/src/pages/Signals.tsx — Fixed `account` query param to `accountId` (matching backend controller expectation)
- backend/prisma/schema.prisma — Added `onDelete: Cascade` to EmailSequence → Organization relation (the only org relation missing it)
- backend/prisma/schema.prisma — Added `onDelete: Cascade` to EmailEnrollment → EmailSequence, EmailEnrollment → Contact, EmailSend → EmailEnrollment, EmailSend → EmailSequenceStep
- backend/prisma/migrations/20260220140000_add_cascade_delete_email_sequences/migration.sql — Migration to alter FK constraints
- backend/tsconfig.json — Added `ts-node: { files: true }` so ts-node honors include globs and picks up `src/types/express.d.ts`

**Production verification:**
- Demo seed: now works (was returning 500 due to FK violation on org delete)
- Health: DB up, Redis up
- Contacts: 18, Signals: 395, PQA: 8 scored accounts, Deals: 3, Workflows: 2
- Migration applied on deploy via `prisma migrate deploy`

**Decisions:**
- Used shared promise pattern for refresh queue (simpler than mutex/semaphore, no added deps)
- Added cascades to entire email sequence chain (Sequence → Steps → Sends, Sequence → Enrollments → Sends) to prevent any future FK issues on org deletion

**Status:** completed
