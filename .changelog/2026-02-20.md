# Changelog — 2026-02-20

## 13:00 — Fix concurrent token refresh race + demo seed cascade delete

**Task:** Fix production demo seed 500 error and token rotation cascade that logged users out on multi-page navigation

**Changes:**
- frontend/src/lib/api.ts — Added shared refresh promise to prevent concurrent 401s from racing on the same refresh token. Multiple simultaneous 401s now queue behind a single refresh call instead of each consuming the token independently.
- frontend/src/pages/Signals.tsx — Fixed `account` query param to `accountId` (matching backend controller expectation)
- backend/prisma/schema.prisma — Added `onDelete: Cascade` to EmailSequence → Organization relation (the only org relation missing it)
- backend/prisma/schema.prisma — Added `onDelete: Cascade` to EmailEnrollment → EmailSequence, EmailEnrollment → Contact, EmailSend → EmailEnrollment, EmailSend → EmailSequenceStep
- backend/prisma/migrations/20260220140000_add_cascade_delete_email_sequences/migration.sql — Migration to alter FK constraints
- backend/tsconfig.json — Added `ts-node: { files: true }` so ts-node honors include globs and picks up `src/types/express.d.ts`

**Production verification:**
- Demo seed: now works (was returning 500 due to FK violation on org delete)
- Health: DB up, Redis up
- Contacts: 18, Signals: 395, PQA: 8 scored accounts, Deals: 3, Workflows: 2
- Migration applied on deploy via `prisma migrate deploy`

**Decisions:**
- Used shared promise pattern for refresh queue (simpler than mutex/semaphore, no added deps)
- Added cascades to entire email sequence chain (Sequence → Steps → Sends, Sequence → Enrollments → Sends) to prevent any future FK issues on org deletion

**Status:** completed

## 21:00 — Enrich demo seed for Show HN + full codebase audit

**Task:** Run comprehensive frontend/backend/demo audits, then enrich demo data for maximum Show HN impact

**Audit Results:**
- Frontend: 58 pages audited, 0 critical bugs, 1 high (console.error in Landing.tsx, fixed)
- Backend: 63 route files audited, 0 critical bugs, all auth properly enforced
- Demo: Data quality excellent, needed more signal volume and AI brief coverage

**Changes:**
- backend/src/services/demo-seed.ts — Increased signal count from 395 to 600 across all 8 companies
- backend/src/services/demo-seed.ts — Added AI briefs for NovaCLI and CloudForge (previously only Acme had one)
- backend/src/services/demo-seed.ts — Added Segment and Discord signal sources (6 total, up from 4)
- backend/src/services/demo-seed.ts — Added 7 new signal templates: segment_identify, segment_track, discord_join, discord_thread, docs_read, github_commit
- frontend/src/pages/Landing.tsx — Removed console.error from demo seed error handler

**Production verification:**
- Demo seed: 8 companies, 18 contacts, 600 signals, 3 deals, 2 workflows
- 3 AI briefs (Acme: expansion, NovaCLI: early adoption, CloudForge: competitive switch)
- PQA: 8 scored accounts with 14-day history
- All endpoints returning correct data

**Decisions:**
- Signal distribution kept proportional: HOT (210/130), WARM (95/65/45), COLD (25/18/12)
- AI briefs varied by narrative: expansion play, founder-friendly pricing, competitive displacement
- Added Segment + Discord sources to better showcase the "16 sources" promise

**Status:** completed

## 22:30 — Production load test, fix search 500 + concurrent demo seed race

**Task:** Run production E2E tests and load test simulating 10 concurrent Show HN visitors; fix all issues found

**Issues Found & Fixed:**

1. **Search 500 error** — `search_vector` column doesn't exist on production (migration marked applied but ALTER TABLE never ran)
   - backend/prisma/migrations/20260220200000_repair_fulltext_search/migration.sql — Repair migration re-adds search_vector columns
   - backend/src/services/search.ts — Added ILIKE fallback for both `globalSearch` and `groupedSearch` so search works even without tsvector columns

2. **Concurrent demo seed race (P2025)** — All 10 concurrent demo seeds tried to delete the same singleton org; first wins, 9 fail
   - backend/src/services/demo-seed.ts — Each demo session now gets a unique slug (`devsignal-demo-{ts}-{random}`) so concurrent visitors don't interfere
   - backend/src/services/demo-seed.ts — `cleanupDemoOrg` now catches P2025 (already deleted) gracefully
   - backend/src/services/demo-seed.ts — `getDemoStatus` uses `findFirst`+`startsWith` instead of `findUnique`
   - backend/src/services/demo-seed.ts — Pre-computed bcrypt hash eliminates ~150ms CPU per request under load

**Load Test Results (10 concurrent visitors):**
- Error rate: 0% (was 90% before fix)
- Landing page: 258ms p50
- Demo seed: 19.8s p50 (600 rows per org, acceptable for one-time setup)
- API browsing: 1.4-2.1s p50 (Railway standard tier latency)
- Verdict: PASS — ready for Show HN traffic

**Decisions:**
- ILIKE fallback is belt-and-suspenders — repair migration should create the columns, but fallback prevents future 500s
- Unique demo slugs trade slight DB bloat for zero-contention concurrency. Cleanup cron already handles stale orgs via `startsWith: 'devsignal-demo'`

**Status:** completed

## 23:30 — Performance optimization: demo loading UX, composite indexes, connection pool

**Task:** Improve Show HN first impression by making the 19.8s demo seed feel fast and optimizing backend query performance

**Research Agents Deployed:**
- API query performance audit — found Prisma already batches includes (not N+1), real bottleneck is Railway cold start + network latency
- Demo loading UX audit — found static spinner with zero progress feedback during 20s wait
- Frontend demo experience audit — confirmed demo users see full dashboard (18 contacts > 5 threshold), PQA page is the "wow" moment

**Changes:**
- frontend/src/pages/Landing.tsx — Added 6-step animated progress overlay during demo seed: Creating sandbox, Seeding companies, Adding contacts, Generating signals, Computing PQA, Building AI briefs. Each step shows check/spin/pending state with progress bar. Added 45s axios timeout.
- backend/prisma/schema.prisma — Added 3 composite indexes: contacts (orgId+email), contacts (orgId+firstName), signals (orgId+accountId+timestamp DESC)
- backend/prisma/migrations/20260220230000_add_composite_indexes/migration.sql — Index creation with IF NOT EXISTS guards
- backend/src/config/database.ts — Bumped connection pool from 10 to 15 per instance

**Decisions:**
- Chose client-side timed progress animation over SSE/streaming — no backend changes needed, step timing roughly matches seed phases, UX improvement is immediate
- Corrected research agent's N+1 analysis — Prisma uses batched IN queries for includes, not individual queries. 1.4-2.1s latency is mostly Railway network + cold start
- Added organizationId+accountId+timestamp index — company detail pages query signals by accountId within org, this was the only genuinely missing composite

**Status:** completed

## 23:45 — Optimize demo seed speed: parallel restructure

**Task:** Reduce demo seed time from 19.8s to ~10-12s by eliminating sequential DB round trips

**Root cause analysis:**
- Railway DB latency is ~0.75-1.4s per round trip (cross-region managed PostgreSQL)
- Demo seed had ~26 sequential DB round trips x 0.75s each = ~19.5s
- Most steps were unnecessarily sequential — many only depend on organizationId, not each other

**Changes:**
- backend/src/services/demo-seed.ts — Complete restructure into 4 parallel phases:
  1. User + org creation in parallel (was 4 sequential, now 2 rounds)
  2. All 6 tags in one parallel batch (was 1 + 5, now 1 round)
  3. CompanyTags + scores + snapshots + contacts + sources all in parallel (was 5 sequential, now 1 round)
  4. Signals + contactTags + dealTags + activities + workflows + briefs in one final parallel batch (was 6+ sequential, now 1 round)
- Signals now created in single createMany call (was 6 batches of 100)
- Account briefs now created in parallel (was 3 sequential creates)

**Expected improvement:** ~20s to ~10-12s (50% reduction in serial round trips)

**Status:** completed

## 00:30 — Show HN conversion optimization

**Task:** Fix high-impact landing page and demo experience issues found by 3-agent audit

**Audit Coverage:**
- Landing page conversion audit (CTA hierarchy, copy consistency, messaging)
- Demo dashboard UX audit (empty states, onboarding, AI errors)
- Backend error handling audit (all critical paths verified solid)

**Changes:**
- frontend/src/pages/Landing.tsx — Swapped CTA buttons: "Explore Live Demo" now primary (indigo), "Start Free" now secondary (gray border). Fixed "5 min Setup" → "2 min Setup" to match copy elsewhere.
- frontend/src/components/DemoModeBanner.tsx — Updated signal count from 395 to 600 (matches current demo seed)
- frontend/src/pages/CompanyDetail.tsx — Added demo-safe AI responses: NextBestActions returns 3 sample actions in demo mode instead of hitting API. Contact enrichment shows success toast instead of API key error.
- docs/show-hn-strategy.md — Updated demo seed data numbers (600 signals, 3 AI briefs)

**Production verification:**
- Demo seed: 14.87s (down from 19.8s after parallel optimization)
- Data integrity: 8 companies, 18 contacts, 600 signals, 3 deals — all verified
- 0 TypeScript errors frontend + backend
- Backend audit: all error handling solid, no 500 risks in any critical path

**Decisions:**
- Demo CTA as primary because HN readers want to see the product live before signing up — demo is the conversion lever
- Sample AI actions in demo mode prevents "API key not configured" error which would be a negative first impression
- Contact enrichment shows demo-friendly toast rather than API error

**Status:** completed

## 01:00 — Hero copy and value prop messaging optimization

**Task:** Improve landing page messaging for maximum Show HN conversion

**Changes:**
- frontend/src/pages/Landing.tsx — Rewrote hero subheading: replaced vague "10+ developer signals" with specific "GitHub, npm, PyPI, Discord, and 12 more sources" + concrete benefit "3+ engineers using your tool"
- frontend/src/pages/Landing.tsx — Changed hero stat from "12x Cheaper" to "$0 Free Tier" (unchallengeable claim for HN)
- frontend/src/pages/Landing.tsx — Rewrote 3 value prop cards from competitor-bashing to outcome-focused:
  - "Signal Detection" → "Instant Discovery"
  - "Price & Speed" → "Zero Friction" (speed to value, not competitor price)
  - "Why We Exist" → "Fits Your Stack" (what it IS, not what it isn't)

**Production verification:**
- Demo seed time: 10.93s (further improved from 14.87s — parallel optimization is highly effective)
- PQA: 8 accounts scored — 2 HOT (92, 84), 3 WARM (71, 67, 55), 3 COLD (42, 31, 18)
- All endpoints verified working: companies, contacts, signals, search, score-snapshots, PQA

**Decisions:**
- "$0 Free Tier" is unchallengeable on HN vs "12x Cheaper" which could be disputed
- Value props now describe customer outcomes, not competitor weaknesses — HN prefers positive framing
- Hero copy now lists specific sources by name (GitHub, npm, PyPI, Discord) for credibility

**Status:** completed

## 01:30 — Cross-page consistency audit + SDK/DevPortal accuracy fixes

**Task:** Fix inconsistencies between landing page, comparison pages, DevPortal, and SDK found by agent audits

**Audit Coverage:**
- Comparison pages (CompareCommonRoom, CompareReodev) vs landing table
- DevPortal webhook event types vs backend WEBHOOK_EVENT_TYPES
- SDK endpoint paths vs backend routes

**Changes:**
- frontend/src/pages/Landing.tsx — Aligned comparison table with dedicated comparison pages: Common Room sources "10+" (was "8-10"), CRM sync includes HubSpot (was "Salesforce only"), setup time "6+ weeks" (was "2-4 weeks")
- frontend/src/pages/CompareCommonRoom.tsx — Standardized "5 minutes" → "2 minutes" setup time across 3 locations
- frontend/src/pages/DevPortal.tsx — Fixed webhook event types to match 8 actual backend types. Removed 5 non-existent events (signal.batch_completed, contact.deleted, deal.closed, score.computed, workflow.triggered). Added missing tier.changed.
- packages/sdk/src/resources/scores.ts — Fixed topAccounts endpoint from /signals/top-accounts → /signals/accounts/top (matching backend route)

**Decisions:**
- Used comparison page values as source of truth over landing table (more conservative/researched claims)
- Honest about Common Room having more CRM integrations (devSignalWins: false) — credibility matters on HN
- SDK endpoint fix is critical since HN developers will try the SDK

**Status:** completed

## 02:00 — Fix demo onboarding hints signal count

**Task:** Update DemoOnboardingHints tour step to reflect enriched demo seed (600 signals, not 395)

**Changes:**
- frontend/src/components/DemoOnboardingHints.tsx — Updated tour step 1 body: "395+ signals" → "600 signals", "real demo data" → "realistic demo data"

**Status:** completed

## 03:00 — Accessibility fixes + Dashboard hero card for demo users

**Task:** Fix keyboard accessibility issues on auth forms, add aria-labels, and create a "Hot Accounts Spotlight" hero card on Dashboard for demo visitors

**Changes:**
- frontend/src/pages/Login.tsx — Password toggle: removed tabIndex={-1} (was keyboard-inaccessible), improved contrast (gray-400 → gray-500), added aria-label
- frontend/src/pages/Register.tsx — Same password toggle fix
- frontend/src/pages/Dashboard.tsx — Added "Hot Accounts Spotlight" hero card for demo users: gradient card showing top 3 HOT/WARM accounts with scores, tiers, and trends. Links to /scores for full PQA view.
- frontend/src/pages/Contacts.tsx, Deals.tsx, Companies.tsx, Activities.tsx — Added aria-label="Close" to modal close buttons
- frontend/src/components/SaveViewModal.tsx, CSVImport.tsx — Added aria-label="Close" to modal close buttons

**Decisions:**
- Hero card only shows for demo users (detected via org name startsWith 'DevSignal Demo')
- Filters to accounts with score >= 70 (HOT/WARM tier) for maximum impact
- Placed above stat cards so it's the first visual element after DemoDataBanner

**Status:** completed

## 02:30 — Add error toasts + OG image + SEO meta tags

**Task:** Fix silent API failures on key demo pages and add OG image for social sharing

**Changes:**
- frontend/src/pages/Signals.tsx — Added useToast import + toast.error on data fetch failure
- frontend/src/pages/SignalFeed.tsx — Added useToast import + toast.error on data fetch failure
- frontend/src/pages/Companies.tsx — Added toast.error on data fetch failure (toast already imported)
- frontend/src/pages/Contacts.tsx — Added toast.error on data fetch failure (toast already imported)
- frontend/src/pages/Deals.tsx — Added toast.error on data fetch failure (toast already imported)
- frontend/src/pages/PQADashboard.tsx — Added useToast import + toast.error on data fetch failure
- frontend/src/pages/Dashboard.tsx — Added useToast import + toast.error on data fetch failure
- frontend/public/og-image.png — Generated 1200x630px OG image (Playwright screenshot of branded HTML)
- frontend/index.html — Added og:image, og:url, twitter:image, canonical URL, upgraded twitter:card to summary_large_image, fixed "5 min" → "2 min" in meta descriptions

**Decisions:**
- Error toasts only on primary data-fetch catch blocks (not polling, load-more, or pagination)
- OG image generated programmatically via Playwright to avoid external tool dependency
- twitter:card upgraded from "summary" to "summary_large_image" for better visual impact on social shares

**Status:** completed

## 02:15 — Show disabled nav items with Pro badges in demo mode

**Task:** Instead of hiding premium features from demo users, show them grayed out with "Pro" badges to increase upgrade desire

**Changes:**
- frontend/src/components/Layout.tsx — Added `disabledInDemo?: boolean` to NavItem interface
- frontend/src/components/Layout.tsx — Changed 5 feature items (Enrichment, Playbooks, Sequences, Webhooks, API Usage) from `hideInDemo` to `disabledInDemo`
- frontend/src/components/Layout.tsx — Added disabled rendering: grayed text, cursor-default, "Pro" badge pill
- Kept 5 admin items as hideInDemo (Settings, Team, Billing, Audit Log, SSO, Data Export) — these add clutter without upgrade value

**Decisions:**
- Features that showcase product depth (Enrichment, Playbooks, Sequences) shown disabled to create FOMO
- Admin items (Settings, Team, Billing) still hidden — they add nav clutter without demonstrating value
- "Pro" badge uses compact uppercase 10px text matching sidebar aesthetic

**Status:** completed
