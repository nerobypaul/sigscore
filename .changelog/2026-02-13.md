## 18:30 — P5: Stripe billing, usage limits, and billing UI

**Task:** Complete and commit the abandoned billing/usage-limits sprint — fix test breakage, commit the full feature
**Changes:**
- backend/src/services/billing.ts — Stripe billing service: checkout sessions, customer portal, webhook handler (checkout.completed, subscription.updated, subscription.deleted, invoice.payment_failed). Fixed eager Stripe client init to lazy-init so tests don't crash on import.
- backend/src/services/usage.ts — Usage service: plan limit definitions (Free/Pro/Scale), real-time usage counts, limit checking
- backend/src/middleware/usage-limits.ts — Plan enforcement middleware: enforceContactLimit, enforceSignalLimit, enforceUserLimit (returns 402 when over plan)
- backend/src/routes/billing.ts — Billing routes: POST /checkout, POST /portal, GET /subscription, plus raw-body webhook endpoint
- backend/src/routes/usage.ts — Usage route: GET /usage returns plan + usage + limits with OpenAPI docs
- backend/src/routes/contacts.ts — Added enforceContactLimit middleware to POST /contacts
- backend/src/routes/signals.ts — Added enforceSignalLimit middleware to POST /signals and POST /signals/batch
- backend/src/config/index.ts — Added stripe config block (secretKey, webhookSecret, pricePro, priceScale) with dev fallbacks
- backend/src/app.ts — Wired usage + billing routes, mounted webhook before express.json() for raw body access
- backend/package.json — Added stripe dependency
- frontend/src/pages/Billing.tsx — Full billing page: current plan banner, usage progress bars, plan comparison cards, Stripe checkout + portal integration
- frontend/src/App.tsx — Added /billing route
- frontend/src/components/Layout.tsx — Added Billing nav link with credit card icon in sidebar

**Decisions:**
- Lazy-initialized Stripe client via getStripe() instead of top-level `new Stripe()` — the eager init caused 5 integration test suites to crash because they import app.ts which imports billing.ts
- Replaced PRICE_TO_PLAN lookup table with inline function to avoid top-level config access
- Billing data stored in Organization.settings JSON field (no schema migration needed)
- Webhook endpoint mounted before express.json() middleware for raw body signature verification
- Usage limits fail open (if limit check errors, request proceeds) to avoid blocking production traffic

**Open questions:**
- Stripe price IDs are placeholders — need real Stripe product/price setup before going live
- No Prisma migration needed since billing state lives in settings JSON, but consider a dedicated table if billing logic grows

**Status:** completed
