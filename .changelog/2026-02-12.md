## 14:30 — Add OpenAPI/Swagger documentation for all REST endpoints

**Task:** Add comprehensive OpenAPI 3.0 documentation to the backend API with Swagger UI.

**Changes:**
- backend/package.json — Added swagger-jsdoc dependency and @types/swagger-jsdoc devDependency.
- backend/src/config/swagger.ts — New file. OpenAPI 3.0.3 spec configuration with swagger-jsdoc, defining 33 component schemas (all CRM entities, request/response bodies, pagination, errors), 2 security schemes (BearerAuth JWT, ApiKeyAuth), shared parameters (OrganizationId, Page, Limit), and 9 tag groups.
- backend/src/routes/auth.ts — Added @openapi JSDoc annotations for all 5 auth endpoints (register, login, refresh, logout, me) with exact request/response schemas.
- backend/src/routes/contacts.ts — Added @openapi JSDoc annotations for all 5 CRUD endpoints with pagination, search, and company filter parameters.
- backend/src/routes/companies.ts — Added @openapi JSDoc annotations for all 5 CRUD endpoints with search and industry filter parameters.
- backend/src/routes/deals.ts — Added @openapi JSDoc annotations for all 5 CRUD endpoints with stage/owner/company filter parameters and PLG pipeline stages.
- backend/src/routes/activities.ts — Added @openapi JSDoc annotations for all 5 CRUD endpoints with type/status/user/contact/company/deal filter parameters.
- backend/src/routes/api-keys.ts — Added @openapi JSDoc annotations for all 4 endpoints (list, create, revoke, delete) noting JWT-only auth requirement.
- backend/src/routes/signals.ts — Added @openapi JSDoc annotations for all 8 endpoints (ingest, batch ingest, query, top accounts, account signals, timeline, get score, compute score).
- backend/src/routes/webhooks.ts — Added @openapi JSDoc annotations for all 3 endpoints (list, create, delete).
- backend/src/routes/signal-sources.ts — Added @openapi JSDoc annotations for all 6 endpoints (list, get, create, update, delete, test).
- backend/src/app.ts — Imported swaggerSpec; added GET /api-docs.json and GET /api/openapi.json for raw JSON spec; mounted Swagger UI at both /api-docs (primary) and /api/docs (legacy).
- backend/src/index.ts — Updated startup log to show /api-docs and /api-docs.json URLs.

**Decisions:**
- Kept /api/docs (legacy) alongside /api-docs (requested) for backward compatibility.
- Schemas mirror the exact Prisma models and service return shapes (verified by reading every controller + service + Prisma schema).
- Auth endpoints use no security scheme in the spec (they are public); all CRM/Signal endpoints list both BearerAuth and ApiKeyAuth as alternatives.
- API Key management endpoints only list BearerAuth since they require JWT (not API key auth).

**Open questions:**
- None

**Status:** completed

---

## 12:00 — Add supertest-based integration tests for backend API

**Task:** Write E2E integration tests using supertest that exercise the full Express request-response lifecycle with mocked Prisma.

**Changes:**
- backend/src/app.ts — New file. Extracted Express app setup from index.ts so it can be imported by supertest without triggering app.listen(). Also mounted the previously-unmounted api-keys route.
- backend/src/index.ts — Refactored to import app from app.ts and only handle server startup.
- backend/src/__tests__/integration/setup.ts — Shared integration test setup: mocks logger, config (with high rate limits for tests), and a deeply-mockable Prisma singleton.
- backend/src/__tests__/integration/helpers.ts — Integration test helpers: real JWT token generation (matching the mocked config secrets), auth header builders, and reusable mock data factories.
- backend/src/__tests__/integration/auth.integration.test.ts — 15 tests covering register, login, refresh, me (protected), and logout flows including validation, expired tokens, and missing headers.
- backend/src/__tests__/integration/contacts.integration.test.ts — 14 tests covering CRUD operations, validation (missing fields, invalid email/URL), auth requirements, and organization scoping.
- backend/src/__tests__/integration/companies.integration.test.ts — 12 tests covering CRUD operations, validation (missing name, invalid enum/email/URL), and auth requirements.
- backend/src/__tests__/integration/deals.integration.test.ts — 15 tests covering CRUD operations, validation (all 9 PLG stages, probability bounds, invalid stage), and auth requirements.
- backend/src/__tests__/integration/api-keys.integration.test.ts — 13 tests covering API key create/list/revoke/delete, validation, API key header auth behavior, and organization access control.

**Decisions:**
- Extracted app.ts from index.ts to avoid port binding during test imports. This is a standard pattern for supertest-based testing.
- Mounted /api/v1/api-keys route which existed as a route file but was never registered in the Express app.
- Used real JWT token generation (jsonwebtoken) with the same secrets as the mocked config, rather than mocking JWT utilities, to exercise the real auth middleware chain.
- Mocked Prisma at the database level but let all middleware (auth, validation, error handling, rate limiting) run for real.
- Set rate limit max to 10000 in test config to avoid interference during rapid test execution.

**Open questions:**
- None

**Status:** completed

---

## 00:00 — Security audit cleanup and .env.example update

**Task:** Fix remaining MEDIUM/LOW security audit findings and complete .env.example

**Changes:**
- .env.example — Added missing env vars: NODE_ENV, PORT, DATABASE_URL, REDIS_PASSWORD, RATE_LIMIT_WINDOW_MS, RATE_LIMIT_MAX_REQUESTS. Added comments explaining each variable and production caveats.
- backend/src/utils/pagination.ts — New utility: `parsePageInt()` for safe query-string integer parsing with NaN protection.
- backend/src/controllers/contacts.ts — Replaced raw `parseInt` with `parsePageInt` for pagination params.
- backend/src/controllers/companies.ts — Same parseInt cleanup.
- backend/src/controllers/deals.ts — Same parseInt cleanup.
- backend/src/controllers/activities.ts — Same parseInt cleanup.
- backend/src/controllers/signals.ts — Same parseInt cleanup; replaced `tier as any` with validated `ScoreTier` enum cast.
- backend/src/controllers/custom-objects.ts — Same parseInt cleanup.
- backend/src/services/deals.ts — Replaced `stage as any` with validated `DealStage` enum cast.
- backend/src/services/activities.ts — Replaced `type as any` and `status as any` with validated `ActivityType` / `ActivityStatus` enum casts.
- backend/src/services/account-scores.ts — Replaced `factors as any` with `Prisma.InputJsonValue` cast.
- backend/src/services/webhooks.ts — Replaced `payload as any` with `Prisma.InputJsonValue` cast.
- backend/src/middleware/api-key-auth.ts — Removed all `(req as any)` casts by extending Express Request type.
- backend/src/types/express.d.ts — Added `apiKeyAuth` and `apiKeyScopes` to Express Request interface.
- backend/src/utils/logger.ts — Production now outputs structured JSON; dev keeps colorized human-readable output.
- backend/src/controllers/auth.ts — Added refresh token reuse detection: when a rotated token is replayed, all sessions for that user are invalidated and a security warning is logged.

**Decisions:**
- Used a shared `parsePageInt` utility instead of inline NaN guards to reduce duplication across 6 controllers.
- For enum filter params (DealStage, ActivityType, etc.), added validation sets so invalid enum values are silently ignored rather than passed to Prisma (which would throw).
- For Prisma Json fields, used `as unknown as Prisma.InputJsonValue` instead of `as any` to maintain type safety while satisfying the Json column constraint.
- Refresh token reuse detection uses the single-token-per-user model: if a previously rotated token is presented (valid JWT, wrong hash), all sessions are nuked. No schema migration needed.

**Status:** completed
