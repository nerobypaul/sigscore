// Prisma Schema for DevSignal — AI-First Headless CRM for DevTool Companies

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// AUTH & TENANCY
// ============================================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String?
  firstName     String
  lastName      String
  avatar        String?
  role          UserRole @default(USER)

  googleId      String?  @unique
  githubId      String?  @unique

  refreshToken  String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?

  organizations UserOrganization[]
  activities    Activity[]
  dealsOwned    Deal[]

  @@index([email])
  @@map("users")
}

enum UserRole {
  ADMIN
  USER
  VIEWER
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  domain      String?
  logo        String?
  settings    Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users              UserOrganization[]
  contacts           Contact[]
  companies          Company[]
  deals              Deal[]
  activities         Activity[]
  tags               Tag[]
  signalSources      SignalSource[]
  signals            Signal[]
  accountScores      AccountScore[]
  customObjectSchemas CustomObjectSchema[]
  webhookEndpoints   WebhookEndpoint[]
  accountBriefs      AccountBrief[]
  apiKeys            ApiKey[]
  workflows          Workflow[]

  @@index([slug])
  @@map("organizations")
}

model UserOrganization {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           OrgRole      @default(MEMBER)

  createdAt      DateTime     @default(now())

  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@map("user_organizations")
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ============================================================
// CORE CRM OBJECTS
// ============================================================

model Contact {
  id             String       @id @default(cuid())
  organizationId String

  firstName      String
  lastName       String
  email          String?
  phone          String?
  mobile         String?
  title          String?
  avatar         String?

  address        String?
  city           String?
  state          String?
  postalCode     String?
  country        String?

  linkedIn       String?
  twitter        String?
  github         String?

  companyId      String?

  notes          String?
  customFields   Json?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  company        Company?     @relation(fields: [companyId], references: [id], onDelete: SetNull)
  deals          Deal[]
  activities     Activity[]
  tags           ContactTag[]
  identities     ContactIdentity[]
  signals        Signal[]

  @@index([organizationId])
  @@index([companyId])
  @@index([email])
  @@index([organizationId, lastName])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("contacts")
}

model Company {
  id             String       @id @default(cuid())
  organizationId String

  name           String
  domain         String?
  industry       String?
  size           CompanySize?
  logo           String?

  email          String?
  phone          String?
  website        String?

  address        String?
  city           String?
  state          String?
  postalCode     String?
  country        String?

  linkedIn       String?
  twitter        String?
  githubOrg      String?

  description    String?
  customFields   Json?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts       Contact[]
  deals          Deal[]
  activities     Activity[]
  tags           CompanyTag[]
  signals        Signal[]
  score          AccountScore?
  briefs         AccountBrief[]

  @@index([organizationId])
  @@index([domain])
  @@index([organizationId, name])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("companies")
}

enum CompanySize {
  STARTUP
  SMALL
  MEDIUM
  LARGE
  ENTERPRISE
}

model Deal {
  id             String       @id @default(cuid())
  organizationId String

  title          String
  amount         Float?
  currency       String       @default("USD")
  stage          DealStage    @default(ANONYMOUS_USAGE)
  probability    Int?

  contactId      String?
  companyId      String?
  ownerId        String?

  expectedCloseDate DateTime?
  closedAt       DateTime?

  description    String?
  customFields   Json?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact        Contact?     @relation(fields: [contactId], references: [id], onDelete: SetNull)
  company        Company?     @relation(fields: [companyId], references: [id], onDelete: SetNull)
  owner          User?        @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  activities     Activity[]
  tags           DealTag[]

  @@index([organizationId])
  @@index([contactId])
  @@index([companyId])
  @@index([ownerId])
  @@index([stage])
  @@index([organizationId, stage, createdAt(sort: Desc)])
  @@map("deals")
}

// PLG-native pipeline stages
enum DealStage {
  ANONYMOUS_USAGE
  IDENTIFIED
  ACTIVATED
  TEAM_ADOPTION
  EXPANSION_SIGNAL
  SALES_QUALIFIED
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

model Activity {
  id             String         @id @default(cuid())
  organizationId String

  type           ActivityType
  title          String
  description    String?

  status         ActivityStatus @default(PENDING)
  priority       Priority       @default(MEDIUM)

  dueDate        DateTime?
  completedAt    DateTime?

  userId         String
  contactId      String?
  companyId      String?
  dealId         String?

  customFields   Json?

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact        Contact?       @relation(fields: [contactId], references: [id], onDelete: SetNull)
  company        Company?       @relation(fields: [companyId], references: [id], onDelete: SetNull)
  deal           Deal?          @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([contactId])
  @@index([companyId])
  @@index([dealId])
  @@index([type])
  @@index([status])
  @@index([organizationId, type, status])
  @@map("activities")
}

enum ActivityType {
  TASK
  CALL
  MEETING
  EMAIL
  NOTE
}

enum ActivityStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================================
// TAGS
// ============================================================

model Tag {
  id             String       @id @default(cuid())
  organizationId String

  name           String
  color          String?

  createdAt      DateTime     @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts       ContactTag[]
  companies      CompanyTag[]
  deals          DealTag[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("tags")
}

model ContactTag {
  contactId String
  tagId     String

  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([contactId, tagId])
  @@map("contact_tags")
}

model CompanyTag {
  companyId String
  tagId     String

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([companyId, tagId])
  @@map("company_tags")
}

model DealTag {
  dealId    String
  tagId     String

  deal      Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  tag       Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([dealId, tagId])
  @@map("deal_tags")
}

// ============================================================
// SIGNAL ENGINE — The core differentiator
// ============================================================

// Configured signal sources (GitHub App, npm tracker, etc.)
model SignalSource {
  id             String             @id @default(cuid())
  organizationId String
  type           SignalSourceType
  name           String
  config         Json               // API keys, repo list, endpoint URLs (encrypted at app layer)
  status         SignalSourceStatus  @default(ACTIVE)
  lastSyncAt     DateTime?
  errorMessage   String?

  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  signals        Signal[]

  @@index([organizationId, type])
  @@map("signal_sources")
}

enum SignalSourceType {
  GITHUB
  NPM
  PYPI
  WEBSITE
  DOCS
  PRODUCT_API
  SEGMENT
  CUSTOM_WEBHOOK
}

enum SignalSourceStatus {
  ACTIVE
  PAUSED
  ERROR
}

// Raw signal events (append-only event log)
model Signal {
  id             String    @id @default(cuid())
  organizationId String
  sourceId       String
  type           String    // repo_clone, package_install, page_view, api_call, signup, etc.

  // Resolved actor & account (nullable if still anonymous)
  actorId        String?
  accountId      String?
  anonymousId    String?   // fingerprint/IP for unresolved signals

  metadata       Json      // source-specific payload
  idempotencyKey String?   @unique
  timestamp      DateTime

  createdAt      DateTime  @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  source         SignalSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  actor          Contact?     @relation(fields: [actorId], references: [id], onDelete: SetNull)
  account        Company?     @relation(fields: [accountId], references: [id], onDelete: SetNull)

  @@index([organizationId, timestamp(sort: Desc)])
  @@index([accountId, timestamp(sort: Desc)])
  @@index([actorId, timestamp(sort: Desc)])
  @@index([type, timestamp(sort: Desc)])
  @@index([sourceId])
  @@index([organizationId, type, timestamp(sort: Desc)])
  @@index([organizationId, sourceId, timestamp(sort: Desc)])
  @@map("signals")
}

// ============================================================
// PQA SCORING — Product-Qualified Account scores
// ============================================================

model AccountScore {
  id             String     @id @default(cuid())
  organizationId String
  accountId      String     @unique
  score          Int        // 0-100
  tier           ScoreTier
  factors        Json       // [{ name, weight, value, description }]
  signalCount    Int        @default(0)
  userCount      Int        @default(0)
  lastSignalAt   DateTime?
  trend          ScoreTrend @default(STABLE)

  computedAt     DateTime
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  account        Company      @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([organizationId, score(sort: Desc)])
  @@index([organizationId, tier])
  @@map("account_scores")
}

enum ScoreTier {
  HOT
  WARM
  COLD
  INACTIVE
}

enum ScoreTrend {
  RISING
  STABLE
  FALLING
}

// ============================================================
// IDENTITY RESOLUTION
// ============================================================

model ContactIdentity {
  id         String       @id @default(cuid())
  contactId  String
  type       IdentityType
  value      String
  verified   Boolean      @default(false)
  confidence Float        @default(1.0)

  createdAt  DateTime     @default(now())

  contact    Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([type, value])
  @@index([contactId])
  @@map("contact_identities")
}

enum IdentityType {
  EMAIL
  GITHUB
  NPM
  TWITTER
  LINKEDIN
  IP
  DOMAIN
}

// ============================================================
// CUSTOM OBJECTS — Metadata-driven extensibility
// ============================================================

model CustomObjectSchema {
  id             String   @id @default(cuid())
  organizationId String
  slug           String
  name           String
  description    String?
  fields         Json     // [{ name, type, required, default }]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  records        CustomObjectRecord[]

  @@unique([organizationId, slug])
  @@map("custom_object_schemas")
}

model CustomObjectRecord {
  id             String   @id @default(cuid())
  schemaId       String
  organizationId String
  data           Json

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  schema         CustomObjectSchema @relation(fields: [schemaId], references: [id], onDelete: Cascade)

  @@index([schemaId, organizationId])
  @@map("custom_object_records")
}

// ============================================================
// AI BRIEFS — Cached AI-generated account intelligence
// ============================================================

model AccountBrief {
  id             String   @id @default(cuid())
  organizationId String
  accountId      String
  content        String   // markdown brief
  generatedAt    DateTime
  validUntil     DateTime // cache expiry
  promptTokens   Int?
  outputTokens   Int?

  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  account        Company      @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, generatedAt(sort: Desc)])
  @@index([organizationId])
  @@map("account_briefs")
}

// ============================================================
// API KEYS — External API authentication
// ============================================================

model ApiKey {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  keyHash        String   @unique // SHA-256 hash of the actual key
  keyPrefix      String   // first 8 chars for identification (ds_live_xxxx...)
  scopes         String[] // e.g. ["signals:write", "accounts:read"]
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  active         Boolean  @default(true)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([keyHash])
  @@map("api_keys")
}

// ============================================================
// WEBHOOKS — Outbound event delivery
// ============================================================

model WebhookEndpoint {
  id             String   @id @default(cuid())
  organizationId String
  url            String
  events         String[] // event types to subscribe to
  secret         String   // HMAC-SHA256 signing secret
  active         Boolean  @default(true)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries     WebhookDelivery[]

  @@index([organizationId])
  @@map("webhook_endpoints")
}

model WebhookDelivery {
  id         String   @id @default(cuid())
  endpointId String
  event      String
  payload    Json
  statusCode Int?
  response   String?
  success    Boolean  @default(false)
  attempts   Int      @default(0)

  createdAt  DateTime @default(now())

  endpoint   WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@index([endpointId, createdAt(sort: Desc)])
  @@map("webhook_deliveries")
}

// ============================================================
// WORKFLOW AUTOMATION — Signal-driven actions
// ============================================================

model Workflow {
  id             String   @id @default(cuid())
  organizationId String

  name           String
  description    String?
  trigger        Json     // { event: "signal_received", filters: { type: "repo_clone" } }
  conditions     Json?    // [{ field: "score", operator: "gte", value: 80 }]
  actions        Json     // [{ type: "create_deal", params: { title: "..." } }]
  enabled        Boolean  @default(true)

  lastTriggeredAt DateTime?
  runCount       Int      @default(0)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  runs           WorkflowRun[]

  @@index([organizationId, enabled])
  @@map("workflows")
}

model WorkflowRun {
  id          String   @id @default(cuid())
  workflowId  String

  status      WorkflowRunStatus
  triggerData Json
  results     Json?
  error       String?
  duration    Int?     // ms

  createdAt   DateTime @default(now())

  workflow    Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, createdAt(sort: Desc)])
  @@map("workflow_runs")
}

enum WorkflowRunStatus {
  SUCCESS
  FAILED
  SKIPPED
}
